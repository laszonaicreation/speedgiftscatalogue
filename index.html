<!DOCTYPE html>
<html lang="ml">

<head>
    <meta charset="UTF-8">
    <!-- UI UPDATE: 2025-12-29 20:35 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speed Gifts | Premium Boutique</title>

    <!-- Fonts Import -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Playfair+Display:ital,wght@0,700;0,800;1,700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ============================================================
           MAIN DESIGN CONFIGURATION (EDIT HERE)
           ============================================================
        */
        :root {
            /* GLOBAL COLORS */
            --website-bg: #ffffff;
            --text-main: #111111;
            --text-muted: #999999;
            --accent-black: #1a1a1a;
            --border-light: #f5f5f5;
            --wishlist-red: #ff4757;

            /* DETAIL VIEW PAGE SETTINGS */
            --detail-page-bg: #ffffff;
            --detail-name-font: 'Inter', sans-serif;
            --detail-name-color: #111111;
            --detail-name-weight: 600;
            --detail-name-size-mob: 1.75rem;
            --detail-name-size-desk: 3rem;
            --detail-price-font: 'Inter', sans-serif;
            --detail-price-color: #111111;
            --detail-price-size: 1.5rem;
            --detail-label-color: #b0b0b0;
            --detail-label-font-size: 10px;
            --detail-desc-color: #555555;
            --detail-desc-size: 14px;

            --font-main: 'Inter', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--website-bg);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            letter-spacing: -0.02em;
            line-height: 1.5;
            margin: 0;
            padding: 0;
        }

        .serif-text {
            font-family: 'Playfair Display', serif;
        }

        /* DETAIL VIEW CSS CLASSES */
        .detail-view-container {
            background-color: var(--detail-page-bg);
            text-align: left;
        }

        .detail-product-name {
            font-family: var(--detail-name-font);
            color: var(--detail-name-color);
            font-weight: var(--detail-name-weight);
            font-size: var(--detail-name-size-mob);
            line-height: 1.2;
        }

        @media (min-width: 768px) {
            .detail-product-name {
                font-size: var(--detail-name-size-desk);
            }
        }

        .detail-price-text {
            font-family: var(--detail-price-font);
            color: var(--detail-price-color);
            font-size: var(--detail-price-size);
            font-weight: 700;
        }

        .detail-label {
            font-size: var(--detail-label-font-size);
            font-weight: 700;
            letter-spacing: 0.05em;
            color: var(--detail-label-color);
            margin-bottom: 4px;
            display: block;
            text-transform: uppercase;
        }

        .detail-description-text {
            color: var(--detail-desc-color);
            font-size: var(--detail-desc-size);
            line-height: 1.6;
        }

        /* CUSTOMER VIEW - Home Card Styling */
        .product-card h3 {
            font-size: 13px;
            font-weight: 600;
        }

        .price-tag {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .brand-logo {
            font-weight: 900;
            letter-spacing: 0.25em;
            font-size: 15px;
        }

        @media (min-width: 768px) {
            .brand-logo {
                font-size: 20px;
            }
        }

        .category-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
            cursor: pointer;
            width: 75px;
            gap: 8px;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            position: relative;
            /* Ensure offsetLeft is reliable */
        }

        .category-img-box {
            width: 66px;
            height: 66px;
            border-radius: 20px;
            padding: 3px;
            background: #fff;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .category-img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 15px;
            transition: transform 0.6s ease;
        }

        /* PREMIUM GOLD BREATHING ANIMATION WITH WHITE GAP */
        @keyframes goldBreathing {
            0% {
                box-shadow: 0 0 0 3px #fff, 0 0 0 4px #111;
                transform: translateY(-6px);
            }

            50% {
                box-shadow: 0 0 0 3px #fff, 0 0 0 4.5px #D4AF37;
                transform: translateY(-8px);
            }

            100% {
                box-shadow: 0 0 0 3px #fff, 0 0 0 4px #111;
                transform: translateY(-6px);
            }
        }

        .active.category-item .category-img-box {
            animation: goldBreathing 3s infinite ease-in-out;
            border-color: transparent;
            /* Hide direct border when active to show the gap shadow */
        }

        .active.category-item .category-img-box img {
            transform: scale(1.1);
        }

        .active.category-item .category-label {
            color: #111;
            font-weight: 900;
            position: relative;
        }

        .active.category-item .category-label::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: #D4AF37;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(212, 175, 55, 0.8);
        }

        /* PREMIUM BUTTON ANIMATION (GOLD/BLACK LINE EFFECT) */
        @keyframes buttonPremiumGlow {
            0% {
                border-color: rgba(0, 0, 0, 0.1);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            }

            50% {
                border-color: #D4AF37;
                box-shadow: 0 5px 25px rgba(212, 175, 55, 0.3);
            }

            100% {
                border-color: rgba(0, 0, 0, 0.1);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            }
        }

        .premium-btn-anim {
            animation: buttonPremiumGlow 3s infinite ease-in-out;
            border-width: 1.5px;
        }

        .category-label {
            font-size: 8.5px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #888;
            text-align: center;
            max-width: 100%;
            transition: all 0.3s ease;
        }

        .img-container {
            aspect-ratio: 3/4;
            overflow: hidden;
            background: #fafafa;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            position: relative;
        }

        .img-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 1.2s ease, opacity 0.5s ease;
            opacity: 0;
        }

        .img-container img[src] {
            opacity: 1;
        }

        /* Smoothing image entry */
        img {
            transition: opacity 0.5s ease;
        }

        img:not([src]),
        img[src=""] {
            opacity: 0;
        }


        /* Smoothing image entry */
        img {
            transition: opacity 0.5s ease;
        }

        img:not([src]),
        img[src=""] {
            opacity: 0;
        }

        /* NEW USABILITY ENHANCEMENTS */
        .category-scroll-container {
            position: relative;
            margin-bottom: 2.5rem;
        }

        .category-scroll-container::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 100%;
            background: linear-gradient(to left, rgba(255, 255, 255, 0.9), transparent);
            pointer-events: none;
            z-index: 5;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .category-scroll-container.scrolled-end::after {
            opacity: 0;
        }

        @keyframes scrollHint {
            0% {
                transform: translateX(0);
            }

            15% {
                transform: translateX(-30px);
            }

            30% {
                transform: translateX(0);
            }
        }

        @keyframes scrollHint {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .scroll-hint-active {
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.4) !important;
            border-color: #D4AF37 !important;
        }

        /* SEARCH TAGS */
        .search-tag {
            padding: 6px 12px;
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 100px;
            font-size: 8px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #666;
            cursor: pointer;
            transition: 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .search-tag:hover {
            background: #111;
            color: #fff;
            border-color: #111;
            transform: translateY(-2px);
        }

        @media (max-width: 767px) {
            .select-btn {
                display: none !important;
            }

            #selection-bar {
                display: none !important;
            }

            .desktop-select-actions {
                display: none !important;
            }
        }

        .select-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 22px;
            height: 22px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            border: 1px solid #eee;
            transition: 0.3s;
        }

        .selected .select-btn {
            background: var(--accent-black);
            color: #fff;
            border-color: var(--accent-black);
        }

        /* WISHLIST BUTTON */
        .wish-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 22px;
            height: 22px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 21;
            border: 1px solid #eee;
            transition: 0.3s;
            color: #ccc;
        }

        .wish-active .wish-btn {
            color: var(--wishlist-red);
        }

        /* SELECTION BAR - Compact Centered */
        #selection-bar {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-black);
            color: #fff;
            padding: 6px 12px;
            border-radius: 100px;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            width: auto;
            min-width: 180px;
            max-width: 95vw;
            backdrop-filter: blur(15px);
        }

        @keyframes slideUpCenter {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .animate-selection {
            animation: slideUpCenter 0.4s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }

        .selection-count {
            font-size: 8.5px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding-left: 4px;
            white-space: nowrap;
        }

        #selection-bar button {
            font-size: 8px !important;
            padding: 4px 10px !important;
            font-weight: 700;
            letter-spacing: 0.03em;
        }

        .thumb-grid {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .thumb-box {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: 0.3s;
        }

        .thumb-box.active {
            border-color: var(--accent-black);
            border-width: 1.5px;
        }

        /* Admin UI Fixes */
        .admin-input {
            width: 100%;
            padding: 0.9rem 1.1rem;
            background: #f9f9f9;
            border: 1px solid transparent;
            border-radius: 12px;
            font-size: 14px;
            transition: 0.3s;
        }

        .admin-input:focus {
            background: #fff;
            border-color: var(--accent-black);
            outline: none;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(12px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeInUp 0.6s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }

        #toast {
            position: fixed;
            bottom: 85px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            display: none;
        }

        .spec-badge {
            background: #fff;
            border: 1px solid #eee;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            color: #333;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        /* NEW ADMIN LIST STYLING */
        #admin-product-list-container {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 8px;
        }

        #admin-product-list-container::-webkit-scrollbar {
            width: 4px;
        }

        #admin-product-list-container::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 10px;
        }

        .admin-list-category-header {
            background: #fdfdfd;
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            margin-top: 25px;
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .stock-badge {
            font-size: 8px;
            font-weight: 900;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }

        .stock-badge.in {
            background: #e6fffa;
            color: #319795;
        }

        .stock-badge.out {
            background: #fff5f5;
            color: #e53e3e;
        }

        /* IMAGE ZOOM EFFECT */
        .zoom-img-container {
            position: relative;
            overflow: hidden;
            cursor: zoom-in;
            border-radius: 2.5rem;
            background: #fff;
            border: 1px solid #f5f5f5;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .zoom-img-container img {
            transition: transform 0.3s ease-out;
            transform-origin: center center;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scale(1);
        }

        /* FULL SCREEN OVERLAY */
        #img-full-preview {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            cursor: zoom-out;
        }

        #img-full-preview img {
            max-width: 95vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        .close-preview-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            z-index: 10001;
            transition: all 0.3s ease;
        }

        .close-preview-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        /* REVERTED ADMIN INPUTS */
        .admin-input {
            width: 100%;
            padding: 0.9rem 1.1rem;
            background: #f9f9f9;
            border: 1px solid transparent;
            border-radius: 12px;
            font-size: 14px;
            transition: 0.3s;
        }

        .admin-input:focus {
            background: #fff;
            border-color: var(--accent-black);
            outline: none;
        }

        /* NEW LARGE ADMIN PRODUCT GRID */
        #admin-product-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        @media (min-width: 1024px) {
            #admin-product-list {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .admin-product-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 20px;
            overflow: hidden;
            transition: 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
            position: relative;
        }

        .admin-product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05);
            border-color: #000;
        }

        .admin-product-img-box {
            aspect-ratio: 1/1;
            position: relative;
            background: #fdfdfd;
        }

        .admin-product-img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .admin-product-info {
            padding: 1rem;
        }

        .admin-card-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            opacity: 0;
            transition: 0.3s;
            z-index: 10;
        }

        .admin-product-card:hover .admin-card-actions {
            opacity: 1;
        }

        .admin-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            color: #666;
            transition: 0.2s;
        }

        .admin-action-btn:hover {
            background: #000;
            color: #fff;
            transform: scale(1.1);
        }

        .admin-action-btn.delete:hover {
            background: #ff4757;
        }
    </style>
</head>

<body class="selection:bg-black selection:text-white">

    <div id="toast"
        class="bg-black text-white px-8 py-4 rounded-xl shadow-2xl text-[10px] font-black tracking-widest uppercase">
    </div>

    <!-- FULL SCREEN PREVIEW OVERLAY -->
    <div id="img-full-preview" onclick="closeFullScreen()">
        <div class="close-preview-btn">
            <i class="fa-solid fa-xmark"></i>
        </div>
        <img id="full-preview-img" src="" alt="Premium Preview">
    </div>


    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-xl border-b border-gray-50">
        <div class="max-w-7xl mx-auto px-5 h-16 md:h-20 flex items-center justify-between">
            <div class="w-1/4">
                <button id="admin-entry-btn"
                    class="hidden bg-black text-white px-4 py-2 rounded-full text-[8px] font-bold tracking-widest uppercase"
                    onclick="showAdminPanel()">
                    Dashboard
                </button>
            </div>
            <div class="flex-1 text-center">
                <h1 class="brand-logo cursor-pointer select-none uppercase truncate leading-none" id="main-logo"
                    onclick="handleLogoClick()">
                    SPEED GIFTS
                </h1>
            </div>
            <div class="w-1/4 flex justify-end items-center">
                <!-- WISHLIST NAV BUTTON -->
                <button onclick="applyFilter('wishlist')"
                    class="relative flex items-center gap-2 text-gray-400 hover:text-red-500 transition-all group">
                    <span
                        class="hidden md:block text-[9px] font-black tracking-widest uppercase group-hover:text-red-500 transition-all">Favorites</span>
                    <div class="relative">
                        <i class="fa-solid fa-heart text-xl"></i>
                        <span id="nav-wishlist-count"
                            class="absolute -top-1.5 -right-1.5 bg-red-500 text-white text-[7px] font-black w-4 h-4 flex items-center justify-center rounded-full border-2 border-white hidden">0</span>
                    </div>
                </button>
            </div>
        </div>
    </nav>

    <div id="loader" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center">
        <div class="w-6 h-6 border-2 border-gray-100 border-t-black rounded-full animate-spin"></div>
        <p class="mt-6 text-[10px] font-black uppercase tracking-[0.25em] text-gray-400 animate-pulse">Loading Speed
            Gifts Catalogue</p>
    </div>

    <main id="app" class="max-w-7xl mx-auto px-5 pt-4 pb-48 min-h-screen">
        <!-- Unified App Container -->
    </main>

    <!-- Templates -->
    <div id="home-view-template" class="hidden">
        <div id="customer-search-container" class="mb-10 fade-in relative">
            <div class="max-w-2xl mx-auto z-[60]">
                <!-- Search Input with its own relative wrapper to keep the icon fixed -->
                <div class="relative group">
                    <i
                        class="fa-solid fa-magnifying-glass absolute left-5 top-1/2 -translate-y-1/2 text-gray-300 text-sm transition-colors group-focus-within:text-black"></i>
                    <input type="text" id="customer-search" oninput="window.applyCustomerSearch(this.value)"
                        onfocus="window.showSearchSuggestions(true)" onblur="window.showSearchSuggestions(false)"
                        class="w-full bg-white border border-gray-100 rounded-[2rem] py-5 pl-14 pr-14 text-[10px] md:text-[11px] font-bold uppercase tracking-widest outline-none focus:border-black transition-all shadow-[0_10px_30px_rgba(0,0,0,0.02)]"
                        placeholder="Search our collection..." autocomplete="off">
                    <!-- CLEAR SEARCH BUTTON -->
                    <button id="clear-search-btn" onclick="window.clearCustomerSearch()"
                        class="hidden absolute right-5 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-full bg-gray-50 text-gray-400 hover:text-black hover:bg-gray-100 transition-all">
                        <i class="fa-solid fa-xmark text-sm"></i>
                    </button>
                </div>

                <!-- TRENDING DROPDOWN - Now Relative to push content instead of overlapping -->
                <div id="search-tags"
                    class="hidden w-full mt-4 p-4 bg-gray-50/50 rounded-3xl border border-gray-100 transition-all duration-500 overflow-hidden">
                    <p class="text-[8px] font-black uppercase tracking-[0.2em] text-gray-300 mb-3 px-1">Trending
                        Searches</p>
                    <div class="flex flex-wrap gap-2">
                        <span onmousedown="window.applyCustomerSearch('Wood Engraving')"
                            class="search-tag !bg-white">Wood Engraving</span>
                        <span onmousedown="window.applyCustomerSearch('Rock Engraving')"
                            class="search-tag !bg-white">Rock Engraving</span>
                        <span onmousedown="window.applyCustomerSearch('Cushion')" class="search-tag !bg-white">Cushion
                            Printing</span>
                        <span onmousedown="window.applyCustomerSearch('Magic Mug')" class="search-tag !bg-white">Magic
                            Mug</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="selection-header" class="hidden mb-10 fade-in">
            <div class="flex flex-col gap-4 border-b border-gray-100 pb-8">
                <div class="space-y-1">
                    <h2 class="text-xl font-black tracking-tight uppercase" id="view-title">Picked for you</h2>
                    <p class="text-[12px] text-gray-400" id="view-subtitle">Exclusive items curated for your boutique
                        experience.</p>
                </div>
                <button onclick="goBackToHome(true)"
                    class="text-[9px] font-bold uppercase tracking-widest px-6 py-3 bg-black text-white rounded-full shadow-lg self-start">View
                    All Products</button>
            </div>
        </div>

        <div id="category-selector-container" class="mb-4 fade-in">
            <p class="text-[10px] md:text-[11px] font-black uppercase tracking-[0.15em] text-gray-400 px-1">Select
                Category</p>
        </div>

        <div class="category-scroll-container">
            <div id="category-row"
                class="no-scrollbar flex gap-4 overflow-x-auto py-8 items-center border-b border-gray-50 px-1 scroll-smooth"
                onscroll="window.handleCategoryRowScroll(this)"></div>
        </div>

        <div class="desktop-select-actions flex justify-between items-center mb-6 hidden md:flex">
            <h3 id="active-category-title"
                class="text-[11px] font-black uppercase tracking-[0.15em] text-gray-400 px-1"></h3>
            <button id="select-all-btn" onclick="toggleSelectAll()"
                class="text-[8.5px] font-black uppercase tracking-widest py-2 px-4 rounded-full border border-gray-100 bg-gray-50 hover:bg-black hover:text-white transition-all text-gray-400">
                Select All Visible
            </button>
        </div>

        <div class="md:hidden mb-6 px-1 flex justify-between items-end">
            <h3 id="active-category-title-mob" class="text-[10px] font-black uppercase tracking-[0.15em] text-gray-400">
            </h3>
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-arrow-up-wide-short text-[10px] text-gray-300"></i>
                <select id="price-sort-mob" onchange="window.applyPriceSort(this.value)"
                    class="bg-transparent text-[10px] font-black uppercase tracking-widest text-gray-500 outline-none border-none">
                    <option value="all">Sort</option>
                    <option value="low">Price: Low-High</option>
                    <option value="high">Price: High-Low</option>
                </select>
            </div>
        </div>

        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-12 md:gap-x-8 md:gap-y-20"></div>
    </div>

    <div id="selection-bar">
        <span class="selection-count" id="selected-count">0 items</span>
        <div class="h-4 w-px bg-white/20"></div>
        <div class="flex gap-2">
            <button onclick="shareSelection()"
                class="bg-white/10 text-white px-3 py-2 rounded-full border border-white/10 whitespace-nowrap">Copy
                link</button>
            <button onclick="sendBulkInquiry()"
                class="bg-white text-black px-3 py-2 rounded-full shadow-lg">WhatsApp</button>
        </div>
        <button onclick="clearSelection()" class="text-white opacity-40 hover:opacity-100 text-sm ml-1 pr-1"><i
                class="fa-solid fa-xmark"></i></button>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden fixed inset-0 z-[60] bg-white overflow-y-auto">
        <div class="max-w-6xl mx-auto px-8 py-20">
            <div class="flex justify-between items-center mb-16">
                <div>
                    <h2 class="text-3xl font-black tracking-tight uppercase">Workspace</h2>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1">Cloud Inventory
                        Manager</p>
                </div>
                <button onclick="hideAdminPanel()"
                    class="w-12 h-12 flex items-center justify-center rounded-full bg-gray-50 text-gray-400 hover:text-black transition-all">âœ•</button>
            </div>

            <div class="flex p-1 bg-gray-50 rounded-2xl mb-12 max-w-sm border border-gray-100 shadow-inner">
                <button onclick="switchAdminTab('products')" id="tab-p"
                    class="flex-1 py-4 rounded-xl text-[10px] font-bold uppercase transition-all bg-white shadow-xl">Products</button>
                <button onclick="switchAdminTab('categories')" id="tab-c"
                    class="flex-1 py-4 rounded-xl text-[10px] font-bold uppercase text-gray-400">Categories</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-16">
                <div class="lg:col-span-5">
                    <!-- Product Section -->
                    <div id="admin-product-section" class="fade-in">
                        <div class="bg-gray-50 p-8 rounded-[2rem] border border-gray-100 space-y-4 shadow-sm">
                            <h3 id="p-form-title" class="text-[11px] font-black uppercase tracking-widest">Product
                                Details</h3>
                            <input type="hidden" id="edit-id">
                            <input type="text" id="p-name" class="admin-input" placeholder="Item Name">
                            <input type="text" id="p-price" class="admin-input" placeholder="Price (AED 50)">
                            <select id="p-cat-id" class="admin-input cursor-pointer">
                                <option value="">Select Category</option>
                            </select>

                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="p-size" class="admin-input" placeholder="Size">
                                <input type="text" id="p-material" class="admin-input" placeholder="Material">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <label
                                    class="flex items-center gap-3 bg-white p-4 rounded-xl border border-gray-100 cursor-pointer">
                                    <input type="checkbox" id="p-stock" class="w-4 h-4 accent-black" checked>
                                    <span
                                        class="text-[11px] font-bold uppercase tracking-widest text-gray-500">Available
                                        in
                                        Stock</span>
                                </label>
                                <label
                                    class="flex items-center gap-3 bg-white p-4 rounded-xl border border-gray-100 cursor-pointer">
                                    <input type="checkbox" id="p-pinned" class="w-4 h-4 accent-black">
                                    <span class="text-[11px] font-bold uppercase tracking-widest text-gray-500">Pin to
                                        Top
                                        (Always First)</span>
                                </label>
                            </div>

                            <div class="bg-white/60 p-4 rounded-xl border border-gray-100 space-y-4">
                                <input type="text" id="p-img"
                                    class="w-full bg-transparent outline-none text-sm font-semibold" value="img/"
                                    placeholder="Image Path 1">
                                <input type="text" id="p-img2"
                                    class="w-full bg-transparent outline-none text-sm font-semibold" value="img/"
                                    placeholder="Image Path 2">
                                <input type="text" id="p-img3"
                                    class="w-full bg-transparent outline-none text-sm font-semibold" value="img/"
                                    placeholder="Image Path 3">
                            </div>
                            <input type="text" id="p-keywords" class="admin-input mt-4 !bg-white"
                                placeholder="Search Keywords (Secret - Hidden from customers)">
                            <textarea id="p-desc" class="admin-input h-32 py-4 resize-none"
                                placeholder="Product Description"></textarea>
                            <button onclick="saveProduct()" id="p-save-btn"
                                class="w-full bg-black text-white py-5 rounded-2xl font-bold text-[11px] uppercase tracking-widest shadow-2 mt-4">Sync
                                Product</button>
                        </div>
                    </div>
                    <!-- Category Section -->
                    <div id="admin-category-section" class="hidden fade-in">
                        <div class="bg-gray-50 p-8 rounded-[2rem] border border-gray-100 space-y-4 shadow-sm">
                            <h3 id="c-form-title" class="text-[11px] font-black uppercase tracking-widest">New Category
                            </h3>
                            <input type="hidden" id="edit-cat-id">
                            <input type="text" id="c-name" class="admin-input" placeholder="Category Title">
                            <input type="text" id="c-img" class="admin-input" value="img/" placeholder="Icon Path">
                            <button onclick="saveCategory()" id="c-save-btn"
                                class="w-full bg-black text-white py-5 rounded-2xl font-bold text-[11px] uppercase tracking-widest shadow-2 mt-4">Sync
                                Category</button>
                        </div>
                    </div>

                    <!-- MIGRATION & CLOUD TOOLS -->
                    <div class="mt-10 p-6 bg-gray-50 rounded-[2rem] border border-gray-100 space-y-4">
                        <h3 class="text-[10px] font-black uppercase tracking-widest text-gray-400 mb-4">Migration &
                            Cloud Tools</h3>
                        <div class="grid grid-cols-1 gap-2">
                            <button onclick="exportExcel()"
                                class="text-[9px] font-black uppercase bg-black text-white py-4 rounded-xl hover:opacity-90 transition-all flex items-center justify-center gap-2">
                                <i class="fa-solid fa-file-excel"></i> Export Excel (CSV)
                            </button>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="exportData()"
                                    class="text-[9px] font-bold uppercase bg-white border border-gray-200 py-3 rounded-xl hover:bg-black hover:text-white transition-all">Backup
                                    JSON</button>
                                <label
                                    class="text-[9px] font-bold uppercase bg-white border border-gray-200 py-3 rounded-xl hover:bg-black hover:text-white transition-all text-center cursor-pointer">
                                    Restore Data
                                    <input type="file" id="import-input" class="hidden" accept=".json"
                                        onchange="importData(event)">
                                </label>
                            </div>
                            <!-- NEW UNIVERSAL MIGRATION BUTTON -->
                            <button onclick="copyUniversalJSON()"
                                class="text-[9px] font-black uppercase bg-white border-2 border-dashed border-gray-200 py-3 rounded-xl hover:border-black transition-all flex items-center justify-center gap-2 text-gray-400 hover:text-black">
                                <i class="fa-solid fa-code"></i> Copy Universal Schema (Dev-Ready)
                            </button>
                        </div>
                        <p class="text-[8px] text-gray-400 text-center italic">Future-proof your data for any database
                            migration.</p>
                    </div>
                </div>
                <div class="lg:col-span-7">
                    <div id="admin-list-controls" class="mb-6 space-y-4">
                        <h4 id="list-title"
                            class="text-[11px] font-bold uppercase tracking-widest text-gray-300 italic">Live Inventory
                        </h4>
                        <div id="product-admin-filters" class="flex flex-col md:flex-row gap-3">
                            <div class="flex-1 relative">
                                <i
                                    class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-300 text-xs"></i>
                                <input type="text" id="admin-search" oninput="renderAdminUI()"
                                    class="admin-input pl-10 py-3 !bg-gray-50 border border-gray-100"
                                    placeholder="Search product name...">
                            </div>
                            <select id="admin-cat-filter" onchange="renderAdminUI()"
                                class="admin-input py-3 !bg-gray-50 border border-gray-100 md:w-48 text-xs font-bold uppercase">
                                <option value="all">All Categories</option>
                            </select>
                        </div>
                    </div>

                    <div id="admin-product-list-container">
                        <div id="admin-product-list" class="space-y-4 fade-in"></div>
                    </div>
                    <div id="admin-category-list" class="hidden space-y-4 fade-in"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBzAGimDQCeuV4oMEQhhUBH8tbsQjBf9hc",
            authDomain: "cataloguedata-9b2be.firebaseapp.com",
            projectId: "cataloguedata-9b2be",
            storageBucket: "cataloguedata-9b2be.firebasestorage.app",
            messagingSenderId: "191169887154",
            appId: "1:191169887154:web:08319d5f3898ed22db02ab"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.projectId;

        const prodCol = collection(db, 'artifacts', appId, 'public', 'data', 'products');
        const catCol = collection(db, 'artifacts', appId, 'public', 'data', 'categories');
        const shareCol = collection(db, 'artifacts', appId, 'public', 'data', 'selections');

        let DATA = { p: [], c: [] };
        let state = { filter: 'all', sort: 'all', search: '', user: null, selected: [], wishlist: [], selectionId: null, scrollPos: 0 };
        let clicks = 0, lastClickTime = 0;

        const startSync = async () => {
            try { await signInAnonymously(auth); }
            catch (err) { console.error(err); }
        };

        onAuthStateChanged(auth, async (u) => {
            state.user = u;
            if (u) {
                await loadWishlist();
                refreshData();
            }
        });

        const handleReentry = () => {
            if (DATA.p.length > 0) {
                const urlParams = new URLSearchParams(window.location.search);
                const pId = urlParams.get('p');
                if (pId) viewDetail(pId, true);
                else renderHome();
                const loader = document.getElementById('loader');
                if (loader) loader.style.display = 'none';
            } else if (auth.currentUser) {
                refreshData();
            }
        };

        window.addEventListener('pageshow', (e) => {
            if (e.persisted || (window.performance && window.performance.navigation.type === 2)) {
                setTimeout(handleReentry, 150);
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                setTimeout(handleReentry, 250);
            }
        });

        window.onfocus = () => { handleReentry(); };

        window.onpopstate = () => {
            refreshData(true);
        };

        // GLOBAL SAFETY: Hide loader no matter what after 6 seconds
        setTimeout(() => {
            const loader = document.getElementById('loader');
            if (loader && loader.style.display !== 'none') {
                console.warn("Safety loader hide triggered.");
                loader.style.display = 'none';
            }
        }, 6000);

        async function loadWishlist() {
            if (!state.user) return;
            try {
                const wishDoc = await getDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'data', 'wishlist'));
                if (wishDoc.exists()) {
                    state.wishlist = wishDoc.data().ids || [];
                    updateWishlistBadge();
                }
            } catch (err) { console.error("Wishlist Load Error"); }
        }

        function updateWishlistBadge() {
            const badge = document.getElementById('nav-wishlist-count');
            if (!badge) return;
            const count = state.wishlist.length;
            if (count > 0) {
                badge.innerText = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        window.toggleWishlist = async (e, id) => {
            e.stopPropagation();
            if (!state.user) return showToast("Authenticating...");
            const card = e.target.closest('.product-card');
            if (state.wishlist.includes(id)) {
                state.wishlist = state.wishlist.filter(x => x !== id);
                if (card) card.classList.remove('wish-active');
            } else {
                state.wishlist.push(id);
                if (card) card.classList.add('wish-active');
            }
            updateWishlistBadge();
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'data', 'wishlist'), { ids: state.wishlist });
                if (state.filter === 'wishlist') renderHome();
            } catch (err) { showToast("Sync Error"); }
        };

        async function refreshData(isNavigationOnly = false) {
            try {
                if (!isNavigationOnly || DATA.p.length === 0) {
                    const [pSnap, cSnap] = await Promise.all([getDocs(prodCol), getDocs(catCol)]);
                    DATA.p = pSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    DATA.c = cSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                }
                const urlParams = new URLSearchParams(window.location.search);
                const shareId = urlParams.get('s');
                const prodId = urlParams.get('p');
                const isAdminOpen = !document.getElementById('admin-panel').classList.contains('hidden');

                if (!isAdminOpen) {
                    if (prodId && DATA.p.length > 0) {
                        viewDetail(prodId, true);
                    } else if (shareId) {
                        try {
                            const selDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'selections', shareId));
                            if (selDoc.exists()) {
                                state.selectionId = shareId;
                                state.selected = selDoc.data().ids;
                            }
                        } catch (e) { console.error("Selection sync failed"); }
                        renderHome();
                    } else {
                        renderHome();
                    }
                } else {
                    renderHome();
                }

                populateCatSelect();
                populateAdminCatFilter();
                renderAdminUI();

                const loader = document.getElementById('loader');
                if (loader) {
                    const safetyTimer = setTimeout(() => { loader.style.display = 'none'; }, 5000);

                    // Priority 1: Category icons (Necessary for navigation)
                    const iconsToLoad = DATA.c.map(c => c.img).filter(u => u && u !== 'img/').slice(0, 10);

                    // Priority 2: Top products for current state (Accounting for current filters)
                    const stockFilter = (items) => items.filter(p => p.inStock !== false);
                    let filteredForPreload = [];
                    if (state.selectionId) filteredForPreload = DATA.p.filter(p => state.selected.includes(p.id));
                    else if (state.filter === 'wishlist') filteredForPreload = DATA.p.filter(p => state.wishlist.includes(p.id));
                    else if (state.filter !== 'all') filteredForPreload = stockFilter(DATA.p.filter(p => p.catId === state.filter));
                    else filteredForPreload = stockFilter(DATA.p);

                    // Sort matching renderHome
                    filteredForPreload.sort((a, b) => {
                        const pinA = a.isPinned ? 1 : 0;
                        const pinB = b.isPinned ? 1 : 0;
                        if (pinA !== pinB) return pinB - pinA;
                        return (b.updatedAt || 0) - (a.updatedAt || 0);
                    });

                    const prodsToLoad = filteredForPreload.slice(0, 8).map(p => p.img).filter(u => u && u !== 'img/');
                    const allToPreload = [...new Set([...prodsToLoad, ...iconsToLoad])];

                    if (allToPreload.length > 0) {
                        // High priority preloading for the top products
                        await Promise.all(allToPreload.map(url => new Promise((resolve) => {
                            const img = new Image();
                            img.src = url;
                            img.onload = resolve;
                            img.onerror = resolve;
                            setTimeout(resolve, 1500); // Shorter timeout to avoid blocking UI
                        })));
                    }
                    clearTimeout(safetyTimer);
                    loader.style.display = 'none';
                }
            } catch (err) {
                console.error(err);
                const loader = document.getElementById('loader');
                if (loader) loader.style.display = 'none';
            }
        }

        const safePushState = (params, replace = false) => {
            try {
                const url = new URL(window.location.href);
                if (params.p === null) url.searchParams.delete('p');
                if (params.s === null) url.searchParams.delete('s');
                Object.keys(params).forEach(key => {
                    if (params[key] !== null) url.searchParams.set(key, params[key]);
                });
                const finalPath = url.pathname + url.search;
                if (replace) window.history.replaceState({}, '', finalPath);
                else window.history.pushState({}, '', finalPath);
            } catch (e) { console.warn("Nav Error"); }
        };

        window.handleLogoClick = () => {
            const now = Date.now();
            if (now - lastClickTime > 5000) clicks = 0;
            clicks++; lastClickTime = now;
            if (clicks >= 5) {
                const btn = document.getElementById('admin-entry-btn');
                if (btn) {
                    btn.classList.toggle('hidden');
                    showToast(btn.classList.contains('hidden') ? "Dashboard Hidden" : "Dashboard Unlocked");
                }
                clicks = 0;
            }
            goBackToHome(false);
        };

        window.goBackToHome = (forceReset = false) => {
            if (forceReset) {
                state.selectionId = null;
                state.selected = [];
                state.filter = 'all';
                state.scrollPos = 0;
                safePushState({ s: null, p: null });
            } else {
                safePushState({ p: null });
            }
            renderHome();
        };

        window.toggleSelectAll = () => {
            if (state.selectionId) return;
            const stockFilter = (items) => items.filter(p => p.inStock !== false);
            let currentVisible = [];
            if (state.filter === 'wishlist') currentVisible = DATA.p.filter(p => state.wishlist.includes(p.id));
            else if (state.filter !== 'all') currentVisible = stockFilter(DATA.p.filter(p => p.catId === state.filter));
            else currentVisible = stockFilter(DATA.p);
            const visibleIds = currentVisible.map(p => p.id);
            const allVisibleSelected = visibleIds.every(id => state.selected.includes(id));
            if (allVisibleSelected) state.selected = state.selected.filter(id => !visibleIds.includes(id));
            else state.selected = Array.from(new Set([...state.selected, ...visibleIds]));
            renderHome();
        };

        function renderHome() {
            try {
                const appMain = document.getElementById('app');
                const template = document.getElementById('home-view-template');
                if (!appMain || !template) return;

                // Simple check: If product grid is absent, load the template
                // This ensures we always have the UI structure.
                if (!appMain.querySelector('#product-grid')) {
                    appMain.innerHTML = template.innerHTML;
                }

                // SELECT ALL ELEMENTS AFTER INJECTION
                const catRow = appMain.querySelector('#category-row');
                const grid = appMain.querySelector('#product-grid');
                const selectionHeader = appMain.querySelector('#selection-header');
                const viewTitle = appMain.querySelector('#view-title');
                const viewSubtitle = appMain.querySelector('#view-subtitle');
                const selectAllBtn = appMain.querySelector('#select-all-btn');
                const activeCatTitle = appMain.querySelector('#active-category-title');
                const activeCatTitleMob = appMain.querySelector('#active-category-title-mob');
                const categorySelector = appMain.querySelector('#category-selector-container');
                const discSearch = appMain.querySelector('#customer-search');
                const clearBtn = appMain.querySelector('#clear-search-btn');
                const mobileSort = appMain.querySelector('#price-sort-mob');

                // 1. Handle selection/wishlist headers
                if (state.selectionId) {
                    if (selectionHeader) selectionHeader.classList.remove('hidden');
                    if (catRow) catRow.classList.add('hidden');
                    if (categorySelector) categorySelector.classList.add('hidden');
                    if (viewTitle) viewTitle.innerText = "Shared Selection";
                    if (viewSubtitle) viewSubtitle.innerText = "Specially picked items for you.";
                } else if (state.filter === 'wishlist') {
                    if (selectionHeader) selectionHeader.classList.remove('hidden');
                    if (catRow) catRow.classList.add('hidden');
                    if (categorySelector) categorySelector.classList.add('hidden');
                    if (viewTitle) viewTitle.innerText = "Your Favorites";
                    if (viewSubtitle) viewSubtitle.innerText = "Items you've saved to your favorites.";
                } else {
                    if (selectionHeader) selectionHeader.classList.add('hidden');
                    if (catRow) catRow.classList.remove('hidden');
                    if (categorySelector) categorySelector.classList.remove('hidden');

                    let cHtml = `<div class="category-item ${state.filter === 'all' ? 'active' : ''}" onclick="applyFilter('all', event)"><div class="category-img-box flex items-center justify-center bg-gray-50 text-[10px] font-black text-gray-300">All</div><p class="category-label">Explore</p></div>`;
                    DATA.c.forEach(c => {
                        cHtml += `<div class="category-item ${state.filter === c.id ? 'active' : ''}" onclick="applyFilter('${c.id}', event)"><div class="category-img-box"><img src="${c.img}" onerror="this.src='https://placehold.co/100x100?text=Gift'"></div><p class="category-label truncate px-1 w-full">${c.name}</p></div>`;
                    });
                    if (catRow) {
                        catRow.innerHTML = cHtml;

                        // Wait for DOM to settle
                        setTimeout(() => {
                            // 1. Auto-scroll active item into view
                            if (state.filter !== 'all') {
                                const activeItem = catRow.querySelector('.category-item.active');
                                if (activeItem) {
                                    // Calculate relative offset within the row
                                    const scrollOffset = activeItem.offsetLeft - catRow.scrollLeft;
                                    // We want it at the start, so we adjust current scroll
                                    catRow.scrollTo({ left: catRow.scrollLeft + (activeItem.getBoundingClientRect().left - catRow.getBoundingClientRect().left) - 16, behavior: 'smooth' });
                                }
                            }

                            // 2. Add hint animation on first load if on mobile and scrollable
                            const isScrollable = catRow.scrollWidth > catRow.clientWidth;
                            if (isScrollable && !window.sessionStorage.getItem('cat_hint_done') && window.innerWidth < 768) {
                                setTimeout(() => {
                                    catRow.scrollTo({ left: 100, behavior: 'smooth' });
                                    setTimeout(() => {
                                        catRow.scrollTo({ left: 0, behavior: 'smooth' });
                                        window.sessionStorage.setItem('cat_hint_done', 'true');
                                    }, 700);
                                }, 1000);
                            }
                        }, 100);
                    }
                }
                let filtered = [];
                const stockFilter = (items) => items.filter(p => p.inStock !== false);
                if (state.selectionId) filtered = DATA.p.filter(p => state.selected.includes(p.id));
                else if (state.filter === 'wishlist') filtered = DATA.p.filter(p => state.wishlist.includes(p.id));
                else if (state.filter !== 'all') filtered = stockFilter(DATA.p.filter(p => p.catId === state.filter));
                else filtered = stockFilter(DATA.p);

                if (state.search) {
                    const q = state.search.toLowerCase().trim();
                    const words = q.split(' ').filter(w => w.length > 0);

                    let source = (state.selectionId || state.filter === 'wishlist') ? filtered : stockFilter(DATA.p);

                    filtered = source.filter(p => {
                        const name = (p.name || '').toLowerCase();
                        const keywords = (p.keywords || '').toLowerCase();
                        const catObj = DATA.c.find(c => c.id === p.catId);
                        const catName = catObj ? catObj.name.toLowerCase() : '';

                        // Match if ALL search words are found in name OR category OR keywords
                        return words.every(word => name.includes(word) || catName.includes(word) || keywords.includes(word));
                    });
                }

                // Sort: Pinned items first, then by selected sort
                filtered.sort((a, b) => {
                    const pinA = a.isPinned ? 1 : 0;
                    const pinB = b.isPinned ? 1 : 0;
                    if (pinA !== pinB) return pinB - pinA; // Pinned first

                    if (state.sort !== 'all') {
                        const priceA = parseFloat(a.price) || 0;
                        const priceB = parseFloat(b.price) || 0;
                        return state.sort === 'low' ? priceA - priceB : priceB - priceA;
                    }
                    return (b.updatedAt || 0) - (a.updatedAt || 0); // Default sort: Newest first
                });
                let catNameDisplay = "All Collections";
                if (state.selectionId) catNameDisplay = "Shared Selection";
                else if (state.filter === 'wishlist') catNameDisplay = "Favorites List";
                else if (state.filter !== 'all') {
                    const catObj = DATA.c.find(c => c.id === state.filter);
                    if (catObj) catNameDisplay = catObj.name;
                }
                if (activeCatTitle) activeCatTitle.innerText = catNameDisplay;
                if (activeCatTitleMob) activeCatTitleMob.innerText = catNameDisplay;
                if (selectAllBtn) {
                    const visibleIds = filtered.map(p => p.id);
                    const allVisibleSelected = visibleIds.length > 0 && visibleIds.every(id => state.selected.includes(id));
                    selectAllBtn.innerText = allVisibleSelected ? "Deselect Visible" : "Select Visible Items";
                    if (state.selectionId) selectAllBtn.parentElement?.classList.add('hidden');
                }
                if (grid) {
                    grid.innerHTML = filtered.map((p, idx) => `
                        <div class="product-card group fade-in ${state.selected.includes(p.id) ? 'selected' : ''} ${state.wishlist.includes(p.id) ? 'wish-active' : ''}" onclick="viewDetail('${p.id}')">
                            <div class="wish-btn shadow-sm" onclick="toggleWishlist(event, '${p.id}')"><i class="fa-solid fa-heart text-[10px]"></i></div>
                            ${!state.selectionId && !state.filter.includes('wishlist') ? `<div class="select-btn shadow-sm" onclick="toggleSelect(event, '${p.id}')"><i class="fa-solid fa-check text-[10px]"></i></div>` : ''}
                            <div class="img-container mb-4 shadow-sm">
                                <img src="${p.img}" 
                                     ${idx < 8 ? 'fetchpriority="high" loading="eager"' : 'fetchpriority="low" loading="lazy"'}
                                     decoding="async"
                                     onload="this.classList.add('loaded')"
                                     alt="${p.name}">
                            </div>
                            <div class="px-1 text-left">
                                <h3 class="capitalize truncate leading-none text-gray-900 font-semibold">${p.name}</h3>
                                <p class="price-tag mt-2 font-bold">${p.price} AED</p>
                            </div>
                        </div>
                    `).join('') || `<p class="col-span-full text-center py-40 text-gray-300 italic text-[11px]">No items found.</p>`;
                }

                // 5. Update Search & Sort UI
                if (discSearch && discSearch !== document.activeElement) discSearch.value = state.search;
                if (clearBtn) {
                    if (state.search) clearBtn.classList.remove('hidden');
                    else clearBtn.classList.add('hidden');
                }
                if (mobileSort) mobileSort.value = state.sort;

                updateSelectionBar();
                if (!state.selectionId && state.filter !== 'wishlist' && !state.search) window.scrollTo({ top: state.scrollPos });
                else if (!state.search) window.scrollTo({ top: 0 });
            } catch (e) {
                console.error("Render Error:", e);
                showToast("UI Display Error");
            }
        }

        // NEW: updateSelectionBar logic explicitly added to prevent ReferenceError
        window.updateSelectionBar = () => {
            const bar = document.getElementById('selection-bar');
            const count = document.getElementById('selected-count');
            if (!bar) return;
            if (state.selected.length > 0 && !state.selectionId && state.filter !== 'wishlist') {
                bar.style.display = 'flex';
                bar.classList.add('animate-selection');
                if (count) count.innerText = `${state.selected.length} items`;
            } else {
                bar.style.display = 'none';
                bar.classList.remove('animate-selection');
            }
        };

        window.viewDetail = (id, skipHistory = false) => {
            const p = DATA.p.find(x => x.id === id);
            if (!p) return;
            if (!skipHistory) {
                const isAlreadyInDetail = new URLSearchParams(window.location.search).has('p');
                state.scrollPos = isAlreadyInDetail ? state.scrollPos : window.scrollY;
                safePushState({ p: id }, isAlreadyInDetail);
            }
            const appMain = document.getElementById('app');
            if (!appMain) return;
            appMain.innerHTML = `
                <div class="max-w-5xl mx-auto py-8 md:py-16 fade-in px-4 pb-64 detail-view-container text-left">
                    <button onclick="goBackToHome()" class="mb-12 text-[10px] font-bold text-gray-400 flex items-center gap-2 uppercase tracking-widest hover:text-black transition-all">
                        <i class="fa-solid fa-arrow-left"></i> Back to ${state.filter === 'wishlist' ? 'Favorites' : (state.selectionId ? 'Selection' : 'Catalogue')}
                    </button>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-20 items-start">
                        <div>
                            <div class="zoom-img-container aspect-square" onmousemove="handleZoom(event, this)" onmouseleave="resetZoom(this)" onclick="openFullScreen('${p.img}')">
                                <img src="${p.img}" id="main-detail-img" class="w-full h-full object-cover" fetchpriority="high" loading="eager">
                            </div>
                            <div class="thumb-grid justify-center lg:justify-start">
                                <div class="thumb-box active" onclick="switchImg('${p.img}', this)"><img src="${p.img}"></div>
                                ${p.img2 && p.img2 !== 'img/' ? `<div class="thumb-box" onclick="switchImg('${p.img2}', this)"><img src="${p.img2}"></div>` : ''}
                                ${p.img3 && p.img3 !== 'img/' ? `<div class="thumb-box" onclick="switchImg('${p.img3}', this)"><img src="${p.img3}"></div>` : ''}
                            </div>
                        </div>
                        <div class="py-2">
                            <span class="text-[9px] font-bold text-gray-300 tracking-[0.05em] uppercase mb-8 block">Exclusive Selection</span>
                            <div class="space-y-12">
                                <div><span class="detail-label">Item name:</span><h2 class="detail-product-name capitalize">${p.name}</h2></div>
                                <div class="flex items-center gap-10 mt-8 mb-10 pb-10 border-b border-gray-100">
                                    <div><span class="detail-label">Listing Price</span><p class="detail-price-text">${p.price} AED</p></div>
                                    <div class="h-10 w-px bg-gray-100"></div>
                                    <div><span class="detail-label">Availability</span><p class="text-sm font-bold text-black flex items-center gap-2">
                                        ${p.inStock !== false ? '<span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> In Stock' : '<span class="w-2 h-2 bg-red-500 rounded-full"></span> Out of Stock'}
                                    </p></div>
                                </div>
                                <div class="flex flex-wrap gap-4 mb-12">
                                    ${p.size ? `<div class="spec-badge"><i class="fa-solid fa-maximize text-[10px] text-gray-400"></i><span>${p.size}</span></div>` : ''}
                                    ${p.material ? `<div class="spec-badge"><i class="fa-solid fa-layer-group text-[10px] text-gray-400"></i><span>${p.material}</span></div>` : ''}
                                </div>
                                <div class="mb-14">
                                    <span class="detail-label">Product Story</span>
                                    <p class="detail-description-text mt-4 whitespace-pre-line">${p.desc || 'Premium handcrafted selection curated specifically for our collection.'}</p>
                                </div>
                                <button onclick="inquireOnWhatsApp('${p.id}')" class="hidden md:flex w-full bg-black text-white py-6 rounded-3xl font-bold text-[11px] uppercase tracking-[0.2em] shadow-xl items-center justify-center gap-3 hover:scale-[1.02] transition-all">
                                    <i class="fa-brands fa-whatsapp text-lg"></i>
                                    INQUIRE ON WHATSAPP
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="fixed md:hidden bottom-0 left-0 w-full flex justify-center p-3 z-[70]">
                    <div class="w-11/12 bg-white/80 backdrop-blur-xl border border-white/20 p-1.5 rounded-full shadow-[0_10px_40px_rgba(0,0,0,0.15)] premium-btn-anim">
                        <button onclick="inquireOnWhatsApp('${p.id}')" class="w-full bg-black text-white py-3.5 rounded-full font-bold text-[10px] uppercase tracking-[0.15em] flex items-center justify-center gap-3 active:scale-95 transition-all">
                            <i class="fa-brands fa-whatsapp text-lg text-green-400"></i>
                            INQUIRE ON WHATSAPP
                        </button>
                    </div>
                </div>
            `;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.saveProduct = async () => {
            const id = document.getElementById('edit-id')?.value;
            const btn = document.getElementById('p-save-btn');
            const data = {
                name: document.getElementById('p-name')?.value,
                price: document.getElementById('p-price')?.value,
                size: document.getElementById('p-size')?.value,
                material: document.getElementById('p-material')?.value,
                inStock: document.getElementById('p-stock')?.checked,
                img: document.getElementById('p-img')?.value,
                img2: document.getElementById('p-img2')?.value,
                img3: document.getElementById('p-img3')?.value,
                catId: document.getElementById('p-cat-id')?.value,
                desc: document.getElementById('p-desc')?.value,
                keywords: document.getElementById('p-keywords')?.value,
                isPinned: document.getElementById('p-pinned')?.checked || false,
                updatedAt: Date.now()
            };
            if (!data.name || !data.img) return showToast("Required info missing");
            if (btn) { btn.disabled = true; btn.innerText = "Syncing..."; }
            try { if (id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id), data); else await addDoc(prodCol, data); showToast("Synced Successfully"); resetForm(); DATA.p = []; refreshData(); }
            catch (e) { showToast("Save Error"); } finally { if (btn) { btn.disabled = false; btn.innerText = "Sync Product"; } }
        };

        window.saveCategory = async () => {
            const id = document.getElementById('edit-cat-id')?.value;
            const btn = document.getElementById('c-save-btn');
            const data = { name: document.getElementById('c-name')?.value, img: document.getElementById('c-img')?.value };
            if (!data.name) return showToast("Name required");
            if (btn) { btn.disabled = true; btn.innerText = "Syncing..."; }
            try { if (id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', id), data); else await addDoc(catCol, data); showToast("Category Synced"); resetForm(); DATA.p = []; refreshData(); }
            catch (e) { showToast("Category Error"); } finally { if (btn) { btn.disabled = false; btn.innerText = "Sync Category"; } }
        };

        window.deleteProduct = async (id) => { if (!confirm("Are you sure?")) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id)); showToast("Deleted"); refreshData(); } catch (e) { showToast("Delete Error"); } };
        window.deleteCategory = async (id) => { if (!confirm("Delete Category?")) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', id)); showToast("Category Removed"); refreshData(); } catch (e) { showToast("Error"); } };

        window.editProduct = (id) => {
            const item = DATA.p.find(x => x.id === id);
            if (!item) return;
            const editId = document.getElementById('edit-id');
            const pName = document.getElementById('p-name');
            const pPrice = document.getElementById('p-price');
            const pSize = document.getElementById('p-size');
            const pMaterial = document.getElementById('p-material');
            const pStock = document.getElementById('p-stock');
            const pPinned = document.getElementById('p-pinned');
            const pImg = document.getElementById('p-img');
            const pImg2 = document.getElementById('p-img2');
            const pImg3 = document.getElementById('p-img3');
            const pCatId = document.getElementById('p-cat-id');
            const pDesc = document.getElementById('p-desc');
            const pKeywords = document.getElementById('p-keywords');
            const pFormTitle = document.getElementById('p-form-title');

            if (editId) editId.value = item.id;
            if (pName) pName.value = item.name;
            if (pPrice) pPrice.value = item.price;
            if (pSize) pSize.value = item.size || "";
            if (pMaterial) pMaterial.value = item.material || "";
            if (pStock) pStock.checked = item.inStock !== false;
            if (pPinned) pPinned.checked = item.isPinned || false;
            if (pImg) pImg.value = item.img || "img/";
            if (pImg2) pImg2.value = item.img2 || "img/";
            if (pImg3) pImg3.value = item.img3 || "img/";
            if (pCatId) pCatId.value = item.catId || "";

            if (pDesc) pDesc.value = item.desc;
            if (pKeywords) pKeywords.value = item.keywords || "";
            if (pFormTitle) pFormTitle.innerText = "Editing: " + item.name;
            switchAdminTab('products');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.editCategory = (id) => {
            const item = DATA.c.find(x => x.id === id);
            if (!item) return;
            const editCatId = document.getElementById('edit-cat-id');
            const cName = document.getElementById('c-name');
            const cImg = document.getElementById('c-img');
            const cFormTitle = document.getElementById('c-form-title');

            if (editCatId) editCatId.value = item.id;
            if (cName) cName.value = item.name;
            if (cImg) cImg.value = item.img;
            if (cFormTitle) cFormTitle.innerText = "Editing: " + item.name;
            switchAdminTab('categories');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.exportData = () => {
            try {
                const backup = { products: DATA.p, categories: DATA.c, timestamp: Date.now() };
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); if (!a) return; a.href = url;
                a.download = `speedgifts_backup_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                showToast("Backup Created!");
            } catch (err) { showToast("Export Failed"); }
        };

        window.exportExcel = () => {
            try {
                if (DATA.p.length === 0) return showToast("No products found");
                const escapeCSV = (val) => { if (val === undefined || val === null) return '""'; let s = String(val).replace(/"/g, '""'); return `"${s}"`; };
                const headers = ["ID", "Name", "Price (AED)", "Category", "Stock Status", "Size", "Material", "Description", "Image 1", "Image 2", "Image 3"];
                const rows = DATA.p.map(p => {
                    const catName = DATA.c.find(c => c.id === p.catId)?.name || "Uncategorized";
                    const stockStatus = p.inStock !== false ? "In Stock" : "Out of Stock";
                    return [p.id, p.name, p.price, catName, stockStatus, p.size || "", p.material || "", p.desc || "", p.img, p.img2 || "", p.img3 || ""].map(escapeCSV).join(",");
                });
                const csvContent = "\uFEFF" + headers.join(",") + "\n" + rows.join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); if (!a) return; a.href = url;
                a.download = `speedgifts_inventory_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                showToast("Excel Exported!");
            } catch (err) { showToast("Export Failed"); }
        };

        // NEW: UNIVERSAL MIGRATION LOGIC (FOR FUTURE DB SWITCHING)
        window.copyUniversalJSON = () => {
            try {
                const universalBackup = {
                    metadata: {
                        source: "Speed Gifts Boutique UI",
                        version: "2.5.0",
                        exportDate: new Date().toISOString(),
                        schema: {
                            products: ["id", "name", "price", "catId", "stockStatus", "size", "material", "description", "images"]
                        }
                    },
                    categories: DATA.c.map(c => ({ id: c.id, name: c.name, iconUrl: c.img })),
                    products: DATA.p.map(p => ({
                        id: p.id,
                        name: p.name,
                        price: p.price,
                        catId: p.catId,
                        stockStatus: p.inStock !== false ? "instock" : "outofstock",
                        specs: { size: p.size || "", material: p.material || "" },
                        description: p.desc || "",
                        images: [p.img, p.img2, p.img3].filter(u => u && u !== 'img/')
                    }))
                };

                const jsonStr = JSON.stringify(universalBackup, null, 2);
                const textArea = document.createElement("textarea");
                if (!textArea) return;
                textArea.value = jsonStr;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast("Universal Migration JSON Copied!");
            } catch (err) { showToast("Migration Prep Failed"); }
        };

        window.importData = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm("This will add items from backup to current project. Continue?")) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    showToast("Restoring... Please Wait");
                    if (data.categories) { for (const cat of data.categories) { const { id, ...cleanCat } = cat; await addDoc(catCol, cleanCat); } }
                    if (data.products) { for (const prod of data.products) { const { id, ...cleanProd } = prod; await addDoc(prodCol, cleanProd); } }
                    showToast("Restore Successful!"); refreshData();
                } catch (err) { showToast("Import Failed"); }
            };
            reader.readAsText(file);
        };

        window.toggleSelect = (e, id) => {
            e.stopPropagation();
            const card = e.target.closest('.product-card');
            if (state.selected.includes(id)) {
                state.selected = state.selected.filter(x => x !== id);
                if (card) card.classList.remove('selected');
            } else {
                state.selected.push(id);
                if (card) card.classList.add('selected');
            }
            updateSelectionBar();
        };

        window.clearSelection = () => { state.selected = []; state.selectionId = null; renderHome(); };

        window.shareSelection = async () => {
            if (state.selected.length === 0) return;
            showToast("Generating link...");
            try {
                const docRef = await addDoc(shareCol, { ids: state.selected, createdAt: Date.now() });
                const shareUrl = `${window.location.origin}${window.location.pathname}?s=${docRef.id}`;
                const textArea = document.createElement("textarea");
                if (!textArea) return;
                textArea.value = shareUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast("Secret Link Copied!");
            }
            catch (e) { showToast("Sharing failed."); }
        };

        window.sendBulkInquiry = () => {
            const items = state.selected.map(id => DATA.p.find(p => p.id === id)).filter(x => x);
            let msg = `*Hello Speed Gifts!*\nI am interested in these items:\n\n`;
            items.forEach((item, i) => { const pUrl = `${window.location.origin}${window.location.pathname}?p=${item.id}`; msg += `${i + 1}. *${item.name}* - ${item.price} AED\nLink: ${pUrl}\n\n`; });
            window.open(`https://wa.me/971561010387?text=${encodeURIComponent(msg)}`);
        };

        window.inquireOnWhatsApp = (id) => {
            const p = DATA.p.find(x => x.id === id);
            if (!p) return;
            const pUrl = `${window.location.origin}${window.location.pathname}?p=${p.id}`;
            const msg = `*Inquiry regarding:* ${p.name}\n*Price:* ${p.price} AED\n\n*Product Link:* ${pUrl}\n\nPlease let me know the availability.`;
            window.open(`https://wa.me/971561010387?text=${encodeURIComponent(msg)}`);
        };

        window.switchImg = (src, el) => {
            const main = document.getElementById('main-detail-img');
            if (main) {
                main.src = src;
                // Update click handler for full-screen preview
                main.closest('.zoom-img-container')?.setAttribute('onclick', `openFullScreen('${src}')`);
            }
            document.querySelectorAll('.thumb-box').forEach(x => x.classList.remove('active'));
            if (el) el.classList.add('active');
        };

        window.handleZoom = (e, container) => {
            // Only zoom if it's a mouse event and not a touch simulation that triggers click
            const img = container?.querySelector('img');
            if (!img) return;
            const rect = container.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;

            img.style.transformOrigin = `${x}% ${y}%`;
            img.style.transform = 'scale(2)';
        };

        window.resetZoom = (container) => {
            const img = container?.querySelector('img');
            if (!img) return;
            img.style.transform = 'scale(1)';
            img.style.transformOrigin = `center center`;
        };

        window.openFullScreen = (src) => {
            const overlay = document.getElementById('img-full-preview');
            const fullImg = document.getElementById('full-preview-img');
            if (overlay && fullImg) {
                fullImg.src = src;
                overlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        };

        window.closeFullScreen = () => {
            const overlay = document.getElementById('img-full-preview');
            if (overlay) {
                overlay.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        };

        window.renderAdminUI = () => {
            const pList = document.getElementById('admin-product-list');
            const cList = document.getElementById('admin-category-list');
            if (!pList || !cList) return;
            const searchEl = document.getElementById('admin-search');
            const filterEl = document.getElementById('admin-cat-filter');
            const searchQuery = searchEl ? searchEl.value.toLowerCase() : "";
            const catFilter = filterEl ? filterEl.value : "all";

            let products = DATA.p.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(searchQuery);
                const matchesCat = catFilter === 'all' || p.catId === catFilter;
                return matchesSearch && matchesCat;
            });

            const grouped = {};
            products.forEach(p => {
                const catName = DATA.c.find(c => c.id === p.catId)?.name || "Uncategorized";
                if (!grouped[catName]) grouped[catName] = [];
                grouped[catName].push(p);
            });

            let pHtml = "";
            Object.keys(grouped).sort().forEach(cat => {
                pHtml += `<div class="col-span-full mt-10 mb-4 flex items-center gap-4">
                    <h5 class="text-[11px] font-black uppercase tracking-[0.2em] text-gray-400 shrink-0">${cat}</h5>
                    <div class="h-[1px] bg-gray-100 flex-1"></div>
                    <span class="text-[9px] font-bold text-gray-300 uppercase shrink-0">${grouped[cat].length} Items</span>
                </div>`;

                grouped[cat].forEach(p => {
                    const stockTag = p.inStock !== false ? '<span class="stock-badge in">In Stock</span>' : '<span class="stock-badge out">Out of Stock</span>';
                    const pinIcon = p.isPinned ? '<div class="absolute top-3 left-3 w-7 h-7 bg-blue-500 text-white rounded-full flex items-center justify-center shadow-lg"><i class="fa-solid fa-thumbtack text-[10px]"></i></div>' : '';

                    pHtml += `
                        <div class="admin-product-card group">
                            <div class="admin-product-img-box">
                                <img src="${p.img}" alt="${p.name}">
                                ${pinIcon}
                                <div class="admin-card-actions">
                                    <button onclick="editProduct('${p.id}')" class="admin-action-btn" title="Edit Item">
                                        <i class="fa-solid fa-pen-to-square text-[11px]"></i>
                                    </button>
                                    <button onclick="deleteProduct('${p.id}')" class="admin-action-btn delete" title="Delete Item">
                                        <i class="fa-solid fa-trash text-[11px]"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="admin-product-info">
                                <h4 class="font-bold text-[13px] capitalize truncate text-gray-800">${p.name}</h4>
                                <div class="flex items-center justify-between mt-1">
                                    <p class="text-[10px] text-gray-500 font-black tracking-widest uppercase">${p.price} AED</p>
                                    ${stockTag}
                                </div>
                            </div>
                        </div>
                    `;
                });
            });

            pList.innerHTML = pHtml || `<div class="col-span-full py-40 text-center"><p class="text-[12px] text-gray-300 font-bold uppercase tracking-widest italic">No items found.</p></div>`;

            cList.innerHTML = DATA.c.map(c => `
                <div class="flex items-center gap-5 p-5 bg-gray-50 rounded-[2rem] border border-gray-100">
                    <img src="${c.img}" class="w-14 h-14 rounded-full object-cover border-4 border-white shadow-sm" onerror="this.src='https://placehold.co/100x100?text=Icon'">
                    <div class="flex-1 font-bold text-[13px] uppercase">${c.name}</div>
                    <div class="flex gap-2">
                        <button onclick="editCategory('${c.id}')" class="w-10 h-10 flex items-center justify-center bg-white rounded-full shadow-lg text-gray-400 hover:text-black transition-all">
                            <i class="fa-solid fa-pen text-[10px]"></i>
                        </button>
                        <button onclick="deleteCategory('${c.id}')" class="w-10 h-10 flex items-center justify-center bg-red-50 rounded-full text-red-200 hover:text-red-500 transition-all">
                            <i class="fa-solid fa-trash text-[10px]"></i>
                        </button>
                    </div>
                </div>
            `).join('') || `<p class="text-center py-20 text-[11px] text-gray-300 italic">No Categories</p>`;
        };

        window.handleCategoryRowScroll = (el) => {
            const container = el.parentElement;
            if (!container) return;
            const isAtEnd = el.scrollLeft + el.clientWidth >= el.scrollWidth - 10;
            if (isAtEnd) container.classList.add('scrolled-end');
            else container.classList.remove('scrolled-end');
        };

        window.applyFilter = (id) => {
            state.filter = id;
            state.search = '';
            state.scrollPos = 0;
            renderHome();
        };
        window.showSearchSuggestions = (show) => {
            const appMain = document.getElementById('app');
            const tags = appMain ? appMain.querySelector('#search-tags') : null;
            if (tags) {
                if (show) tags.classList.remove('hidden');
                else setTimeout(() => {
                    const currentTags = document.getElementById('app')?.querySelector('#search-tags');
                    if (currentTags) currentTags.classList.add('hidden');
                }, 200);
            }
        };
        let searchTimeout;
        window.applyCustomerSearch = (val) => {
            state.search = val;
            if (val && state.filter !== 'wishlist' && !state.selectionId) {
                state.filter = 'all';
            }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                renderHome();
            }, 100);

            // Update Clear Button UI immediately with safety
            const clearBtn = document.getElementById('app')?.querySelector('#clear-search-btn');
            if (clearBtn) {
                if (val) clearBtn.classList.remove('hidden');
                else clearBtn.classList.add('hidden');
            }
        };
        window.clearCustomerSearch = () => {
            state.search = '';
            renderHome();
            const input = document.getElementById('customer-search');
            if (input) input.focus();
        };
        window.applyPriceSort = (sort) => { state.sort = sort; renderHome(); };
        window.showAdminPanel = () => { document.getElementById('admin-panel').classList.remove('hidden'); document.body.style.overflow = 'hidden'; renderAdminUI(); };
        window.hideAdminPanel = () => { document.getElementById('admin-panel').classList.add('hidden'); document.body.style.overflow = 'auto'; };

        window.switchAdminTab = (tab) => {
            const isProd = tab === 'products';
            document.getElementById('admin-product-section').classList.toggle('hidden', !isProd);
            document.getElementById('admin-category-section').classList.toggle('hidden', isProd);
            document.getElementById('admin-product-list-container').classList.toggle('hidden', !isProd);
            document.getElementById('admin-category-list').classList.toggle('hidden', isProd);
            document.getElementById('product-admin-filters').classList.toggle('hidden', !isProd);
            document.getElementById('tab-p').className = isProd ? "flex-1 py-4 rounded-xl text-[10px] font-bold uppercase bg-white shadow-xl" : "flex-1 py-4 rounded-xl text-[10px] font-bold uppercase text-gray-400";
            document.getElementById('tab-c').className = !isProd ? "flex-1 py-4 rounded-xl text-[10px] font-bold uppercase bg-white shadow-xl" : "flex-1 py-4 rounded-xl text-[10px] font-bold uppercase text-gray-400";
            document.getElementById('list-title').innerText = isProd ? "Live Inventory" : "Existing Categories";
        };

        /* CATEGORY PICKER LOGIC */

        function populateCatSelect() {
            const select = document.getElementById('p-cat-id');
            if (select) select.innerHTML = `<option value="">Select Category</option>` + DATA.c.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function populateAdminCatFilter() {
            const select = document.getElementById('admin-cat-filter');
            if (select) select.innerHTML = `<option value="all">All Categories</option>` + DATA.c.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        window.resetForm = () => {
            const fields = ['edit-id', 'edit-cat-id', 'p-name', 'p-price', 'p-size', 'p-material', 'p-desc', 'p-keywords', 'c-name'];
            fields.forEach(f => { const el = document.getElementById(f); if (el) el.value = ""; });
            document.getElementById('p-img').value = "img/"; document.getElementById('p-img2').value = "img/"; document.getElementById('p-img3').value = "img/";
            document.getElementById('c-img').value = "img/";
            document.getElementById('p-stock').checked = true;
            document.getElementById('p-pinned').checked = false;
            document.getElementById('p-form-title').innerText = "Product Details";
            document.getElementById('c-form-title').innerText = "New Category";

            if (document.getElementById('admin-search')) document.getElementById('admin-search').value = "";
            if (document.getElementById('admin-cat-filter')) document.getElementById('admin-cat-filter').value = "all";
        };

        function showToast(msg) {
            const t = document.getElementById('toast'); if (!t) return;
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 3000);
        }

        startSync();
    </script>
</body>

</html>